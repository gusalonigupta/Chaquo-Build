name: Build Chaquopy Android Library AAR

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        
    - name: Setup Android SDK
      uses: android-actions/setup-android@v3
      
    - name: Create gradle wrapper properties
      run: |
        mkdir -p gradle/wrapper
        echo "distributionUrl=https\://services.gradle.org/distributions/gradle-8.13-bin.zip" > gradle/wrapper/gradle-wrapper.properties
        
    - name: Download gradle wrapper files
      run: |
        curl -L https://raw.githubusercontent.com/gradle/gradle/v8.13.0/gradle/wrapper/gradle-wrapper.jar -o gradle/wrapper/gradle-wrapper.jar
        curl -L https://raw.githubusercontent.com/gradle/gradle/v8.13.0/gradlew -o gradlew
        curl -L https://raw.githubusercontent.com/gradle/gradle/v8.13.0/gradlew.bat -o gradlew.bat
      
    - name: Make gradlew executable
      run: chmod +x ./gradlew
        
    - name: Cache Gradle packages
      uses: actions/cache@v3
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
        key: ${{ runner.os }}-gradle-${{ hashFiles('**/gradle-wrapper.properties') }}
        restore-keys: |
          ${{ runner.os }}-gradle-
        
    - name: Build Debug AAR
      run: ./gradlew :lib:assembleDebug
        
    - name: Build AAR for abi32 (Python 3.11)
      run: ./gradlew :lib:assembleAbi32Debug
        
    - name: Upload abi32 AAR
      uses: actions/upload-artifact@v4
      with:
        name: lib-abi32-debug.aar
        path: lib/build/outputs/aar/lib-abi32-debug.aar

    - name: Build AAR for abi64 (Python 3.12)
      run: ./gradlew :lib:assembleAbi64Debug
        
    - name: Upload abi64 AAR
      uses: actions/upload-artifact@v4
      with:
        name: lib-abi64-debug.aar
        path: lib/build/outputs/aar/lib-abi64-debug.aar